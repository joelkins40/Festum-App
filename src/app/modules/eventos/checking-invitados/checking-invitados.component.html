<div class="checking-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <mat-icon class="header-icon">how_to_reg</mat-icon>
      <div>
        <h1>Checking de Invitados</h1>
        <p class="subtitle">Registro de asistencia al evento</p>
      </div>
    </div>
  </div>

  <!-- Event Selector -->
  <mat-card class="selector-card">
    <mat-card-content>
      <div class="selector-toolbar">
        <mat-form-field appearance="outline" class="event-selector">
          <mat-label>Seleccionar Evento</mat-label>
          <mat-select [(ngModel)]="selectedEventId" (selectionChange)="onEventoChange()">
            <mat-option [value]="null">-- Seleccione un evento --</mat-option>
            @for (evento of eventos; track evento.id) {
            <mat-option [value]="evento.id">
              {{ evento.name }} - {{ evento.folio }} ({{ evento.date }})
            </mat-option>
            }
          </mat-select>
          <mat-icon matPrefix>event</mat-icon>
        </mat-form-field>

        <button mat-raised-button color="accent" (click)="refreshData()" [disabled]="!selectedEventId"
          matTooltip="Actualizar datos">
          <mat-icon>refresh</mat-icon>
          Actualizar
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  @if (selectedEventId) {
  <!-- Statistics Cards -->
  <div class="stats-cards">
    <mat-card class="stat-card total">
      <mat-card-content>
        <div class="stat-content">
          <mat-icon class="stat-icon">people</mat-icon>
          <div class="stat-info">
            <p class="stat-label">Total Invitados</p>
            <p class="stat-value">{{ stats.totalGuests }}</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card checked-in">
      <mat-card-content>
        <div class="stat-content">
          <mat-icon class="stat-icon">check_circle</mat-icon>
          <div class="stat-info">
            <p class="stat-label">Registrados</p>
            <p class="stat-value">{{ stats.checkedIn }}</p>
            <p class="stat-percentage">{{ getAttendancePercentage() }}%</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card pending">
      <mat-card-content>
        <div class="stat-content">
          <mat-icon class="stat-icon">pending</mat-icon>
          <div class="stat-info">
            <p class="stat-label">Pendientes</p>
            <p class="stat-value">{{ stats.pending }}</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card total-people">
      <mat-card-content>
        <div class="stat-content">
          <mat-icon class="stat-icon">groups</mat-icon>
          <div class="stat-info">
            <p class="stat-label">Total Personas</p>
            <p class="stat-value">{{ stats.totalPeople }}</p>
            <p class="stat-hint">Invitados + Acompañantes</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Guest Table -->
  <mat-card class="main-card">
    <mat-card-content>
      <!-- Search Toolbar -->
      <div class="table-toolbar">
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Buscar invitado</mat-label>
          <input matInput [(ngModel)]="searchTerm" (keyup)="applyFilter()"
            placeholder="Nombre, código de reservación..." />
          <mat-icon matPrefix>search</mat-icon>
          @if (searchTerm) {
          <button mat-icon-button matSuffix (click)="clearFilter()" matTooltip="Limpiar búsqueda">
            <mat-icon>close</mat-icon>
          </button>
          }
        </mat-form-field>
      </div>

      <!-- Loading Spinner -->
      @if (isLoading) {
      <div class="loading-container">
        <mat-spinner diameter="50"></mat-spinner>
        <p>Cargando invitados...</p>
      </div>
      }

      <!-- Table -->
      @if (!isLoading) {
      <div class="table-container">
        <table mat-table [dataSource]="dataSource" matSort class="checking-table">
          <!-- Reservation Code Column -->
          <ng-container matColumnDef="reservationCode">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              Código Reservación
            </th>
            <td mat-cell *matCellDef="let invitado">
              <div class="code-cell">
                <mat-icon class="cell-icon">qr_code</mat-icon>
                <span class="code-badge">{{ invitado.reservationCode }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Full Name Column -->
          <ng-container matColumnDef="fullName">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              Nombre Completo
            </th>
            <td mat-cell *matCellDef="let invitado">
              <div class="name-cell">
                <mat-icon class="cell-icon">person</mat-icon>
                <span>{{ invitado.fullName }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Contact Phone Column -->
          <ng-container matColumnDef="contactPhone">
            <th mat-header-cell *matHeaderCellDef>Teléfono</th>
            <td mat-cell *matCellDef="let invitado">
              <div class="phone-cell">
                <mat-icon class="cell-icon">phone</mat-icon>
                <div class="phone-info">
                  <span class="phone-main">{{ invitado.contactPhone }}</span>
                  @if (invitado.secondaryPhone) {
                  <span class="phone-secondary">{{
                    invitado.secondaryPhone
                    }}</span>
                  }
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Companions Column -->
          <ng-container matColumnDef="companions">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              Acompañantes
            </th>
            <td mat-cell *matCellDef="let invitado">
              <div class="companions-cell">
                <mat-icon class="cell-icon">group_add</mat-icon>
                <span class="companions-count">{{ invitado.companions }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Estado</th>
            <td mat-cell *matCellDef="let invitado">
              @if (invitado.checkedIn) {
              <div class="status-checked">
                <mat-chip class="chip-checked">
                  <mat-icon>check_circle</mat-icon>
                  Registrado
                </mat-chip>
                @if (invitado.checkInTime) {
                <span class="check-time">{{
                  formatCheckInTime(invitado.checkInTime)
                  }}</span>
                }
              </div>
              } @else {
              <mat-chip class="chip-pending">
                <mat-icon>pending</mat-icon>
                Pendiente
              </mat-chip>
              }
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Acciones</th>
            <td mat-cell *matCellDef="let invitado">
              @if (!invitado.checkedIn) {
              <button mat-raised-button color="primary" (click)="checkIn(invitado)" class="check-in-btn">
                <mat-icon>how_to_reg</mat-icon>
                Registrar
              </button>
              } @else {
              <button mat-icon-button color="warn" (click)="undoCheckIn(invitado)" matTooltip="Deshacer registro"
                class="undo-btn">
                <mat-icon>undo</mat-icon>
              </button>
              }
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns" [class.checked-row]="row.checkedIn"></tr>

          <!-- No data row -->
          <tr class="mat-row" *matNoDataRow>
            <td class="mat-cell no-data-row" [attr.colspan]="displayedColumns.length">
              <div class="no-data-message">
                <mat-icon>person_off</mat-icon>
                <p>No se encontraron invitados</p>
              </div>
            </td>
          </tr>
        </table>
      </div>

      <!-- Paginator -->
      <mat-paginator [pageSizeOptions]="[10, 25, 50, 100]" [pageSize]="25" showFirstLastButtons></mat-paginator>
      }
    </mat-card-content>
  </mat-card>
  } @else {
  <!-- Empty State -->
  <mat-card class="empty-state-card">
    <mat-card-content>
      <div class="empty-state">
        <mat-icon>event_available</mat-icon>
        <h2>Seleccione un evento</h2>
        <p>
          Por favor, seleccione un evento en el selector superior para comenzar
          el checking de invitados.
        </p>
      </div>
    </mat-card-content>
  </mat-card>
  }
</div>
