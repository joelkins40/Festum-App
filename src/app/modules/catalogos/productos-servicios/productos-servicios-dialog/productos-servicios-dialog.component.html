<!-- 游닇 Modal para Crear/Editar Productos y Servicios -->
<div class="productos-servicios-dialog">
  
  <!-- Header del Modal -->
  <div class="dialog-header">
    <div class="header-content">
      <mat-icon class="header-icon">{{ getIcono() }}</mat-icon>
      <h2 class="header-title">{{ getTitulo() }}</h2>
    </div>
    <button mat-icon-button 
            (click)="onCancel()" 
            class="close-button"
            matTooltip="Cerrar">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Contenido del Modal -->
  <div class="dialog-content">
    
    <!-- Loading Overlay -->
    <div *ngIf="guardando" class="loading-overlay">
      <div class="loading-content">
        <mat-progress-spinner 
          diameter="50" 
          mode="indeterminate"
          color="primary">
        </mat-progress-spinner>
        <p>{{ modo === 'crear' ? 'Creando...' : 'Actualizando...' }}</p>
      </div>
    </div>

    <!-- Formulario -->
    <form [formGroup]="productoServicioForm" class="dialog-form">
      
      <!-- Fila 1: Tipo y Categor칤a -->
      <div class="form-row">
        <div class="form-field">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Tipo *</mat-label>
            <mat-select formControlName="tipo" required>
              <mat-option *ngFor="let tipo of tiposDisponibles" 
                          [value]="tipo.value">
                <mat-icon>{{ tipo.value === 'Producto' ? 'inventory_2' : 'miscellaneous_services' }}</mat-icon>
                {{ tipo.label }}
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>category</mat-icon>
            <mat-error *ngIf="f['tipo'].hasError('required')">
              El tipo es requerido
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-field">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Categor칤a *</mat-label>
            <mat-select formControlName="categoriaId" required>
              <mat-option *ngFor="let categoria of categorias$ | async" 
                          [value]="categoria.id">
                {{ categoria.descripcion }}
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>label</mat-icon>
            <mat-error *ngIf="f['categoriaId'].hasError('required')">
              La categor칤a es requerida
            </mat-error>
            <!-- Loading indicator para categor칤as -->
            <mat-progress-spinner 
              *ngIf="cargandoCategorias" 
              matSuffix 
              diameter="20" 
              mode="indeterminate">
            </mat-progress-spinner>
          </mat-form-field>
        </div>
      </div>

      <!-- Fila 2: Clave y Stock -->
      <div class="form-row">
        <div class="form-field">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Clave *</mat-label>
            <input matInput 
                   formControlName="clave"
                   (input)="onClaveChange($event)"
                   placeholder="Ej: PRD001"
                   maxlength="20"
                   required>
            <mat-icon matSuffix>tag</mat-icon>
            <mat-hint>Solo letras may칰sculas y n칰meros</mat-hint>
            <mat-error *ngIf="f['clave'].hasError('required')">
              La clave es requerida
            </mat-error>
            <mat-error *ngIf="f['clave'].hasError('minlength')">
              M칤nimo 3 caracteres
            </mat-error>
            <mat-error *ngIf="f['clave'].hasError('pattern')">
              Solo letras may칰sculas y n칰meros
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-field">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Cantidad en Stock *</mat-label>
            <input matInput 
                   type="number"
                   formControlName="cantidadStock"
                   (input)="onStockChange($event)"
                   placeholder="0"
                   min="0"
                   required>
            <mat-icon matSuffix>inventory</mat-icon>
            <mat-hint>Cantidad disponible en inventario</mat-hint>
            <mat-error *ngIf="f['cantidadStock'].hasError('required')">
              La cantidad es requerida
            </mat-error>
            <mat-error *ngIf="f['cantidadStock'].hasError('min')">
              Debe ser mayor o igual a 0
            </mat-error>
            <mat-error *ngIf="f['cantidadStock'].hasError('pattern')">
              Solo n칰meros enteros
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <!-- Fila 3: Nombre -->
      <div class="form-row">
        <div class="form-field full">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Nombre *</mat-label>
            <input matInput 
                   formControlName="nombre"
                   placeholder="Nombre descriptivo del producto o servicio"
                   maxlength="150"
                   required>
            <mat-icon matSuffix>title</mat-icon>
            <mat-hint>{{ f['nombre'].value?.length || 0 }}/150</mat-hint>
            <mat-error *ngIf="f['nombre'].hasError('required')">
              El nombre es requerido
            </mat-error>
            <mat-error *ngIf="f['nombre'].hasError('minlength')">
              M칤nimo 3 caracteres
            </mat-error>
            <mat-error *ngIf="f['nombre'].hasError('maxlength')">
              M치ximo 150 caracteres
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <!-- Fila 4: Descripci칩n -->
      <div class="form-row">
        <div class="form-field full">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Descripci칩n</mat-label>
            <textarea matInput 
                      formControlName="descripcion"
                      placeholder="Descripci칩n detallada del producto o servicio (opcional)"
                      maxlength="500"
                      rows="3">
            </textarea>
            <mat-icon matSuffix>description</mat-icon>
            <mat-hint>{{ f['descripcion'].value?.length || 0 }}/500 - Campo opcional</mat-hint>
            <mat-error *ngIf="f['descripcion'].hasError('maxlength')">
              M치ximo 500 caracteres
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <!-- Fila 5: Precios -->
      <div class="form-row">
        <div class="form-field">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Precio P칰blico General *</mat-label>
            <input matInput 
                   type="number"
                   formControlName="precioPublico"
                   (input)="onPrecioChange($event, 'precioPublico')"
                   placeholder="0.00"
                   min="0.01"
                   step="0.01"
                   required>
            <span matTextPrefix>$&nbsp;</span>
            <mat-icon matSuffix>attach_money</mat-icon>
            <mat-hint>Precio para clientes en general</mat-hint>
            <mat-error *ngIf="f['precioPublico'].hasError('required')">
              El precio p칰blico es requerido
            </mat-error>
            <mat-error *ngIf="f['precioPublico'].hasError('min')">
              Debe ser mayor a 0
            </mat-error>
            <mat-error *ngIf="f['precioPublico'].hasError('pattern')">
              Formato inv치lido (ej: 100.50)
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-field">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Precio Clientes Especiales *</mat-label>
            <input matInput 
                   type="number"
                   formControlName="precioEspecial"
                   (input)="onPrecioChange($event, 'precioEspecial')"
                   placeholder="0.00"
                   min="0.01"
                   step="0.01"
                   required>
            <span matTextPrefix>$&nbsp;</span>
            <mat-icon matSuffix>star</mat-icon>
            <mat-hint>Precio con descuento para clientes especiales</mat-hint>
            <mat-error *ngIf="f['precioEspecial'].hasError('required')">
              El precio especial es requerido
            </mat-error>
            <mat-error *ngIf="f['precioEspecial'].hasError('min')">
              Debe ser mayor a 0
            </mat-error>
            <mat-error *ngIf="f['precioEspecial'].hasError('pattern')">
              Formato inv치lido (ej: 85.00)
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <!-- Error de validaci칩n de precios -->
      <div *ngIf="tienePrecioEspecialMayor" class="price-error-message">
        <mat-icon>error</mat-icon>
        <span>El precio especial no puede ser mayor al precio p칰blico</span>
      </div>

    </form>
  </div>

  <!-- Acciones del Modal -->
  <div class="dialog-actions">
    <button mat-button 
            type="button"
            (click)="onCancel()"
            [disabled]="guardando"
            class="cancel-button">
      <mat-icon>cancel</mat-icon>
      Cancelar
    </button>
    
    <button mat-raised-button 
            color="primary"
            type="button"
            (click)="onSave()"
            [disabled]="!productoServicioForm.valid || guardando"
            class="save-button">
      <mat-icon>{{ guardando ? 'hourglass_empty' : 'save' }}</mat-icon>
      {{ guardando ? 'Guardando...' : (modo === 'crear' ? 'Crear' : 'Actualizar') }}
    </button>
  </div>

</div>